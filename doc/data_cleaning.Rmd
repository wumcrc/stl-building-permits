---
title: "data_cleaning"
author: "Logan Williams"
date: "2/24/2020"
output: html_document
params:
  
  #Change Every month
  month: December
  year: 2021 
  
  # First day of next month | Change this each month
  enddate: "2022-01-01"
  
  #6 Months prior to the first of the current month (subtract `enddate` month by 7)
  month6: "2021-06-01"
---

### Introduction

This file is used to clean data from the city of St Louis and convert it into a .csv file which will be stored in my `data` folder. This file is complied by Logan Williams for use by the WUMCRC.

## Dependencies

```{r, message=FALSE}

#Load dependencies

library(dplyr)        #data cleaning
library(RODBC)        #ODBC database connectivity
library(ggplot2)      #chart making
library(here)         #file paths
library(readr)        #Write csv
library(writexl)      #write excel
library(lubridate)    #manipulate date time data
```

```{r}
# This code chunk creates the appropriate folder paths that are referred to in all of the .Rmd documents. 
# This code is necessary to knit and compile the powerpoint presentations.
abbr <- c("ac", "cwe", "dbp", "fp", "fpse", "lp", "sdbp", "vd", "vp", "we", "all_nbhds")
here::here()
dir.create(getwd())
dir.create(here::here(file.path("results", params$year)))
dir.create(here::here(file.path("results", params$year, params$month)))
dir.create(here::here(file.path("results", "presentations", params$year)))
dir.create(here::here(file.path("results", "presentations", params$year, params$month)))
dir.create(here::here(file.path("data", params$year)))
dir.create(here::here(file.path("data", params$year, params$month)))
dir.create(here::here(file.path("data", params$year, params$month, "shapefiles")))
for (i in abbr) {
  dir.create(here::here(file.path("results", params$year, params$month, i)))
}
```

### Temporary Code
```{r, message=FALSE}
library(readxl)
data <- read_excel(here::here("data", "PrmBldg.xlsx"), guess_max = 1048576)
cat <- read_excel(here::here("data", "working-db", "bldgpermits", "bldg-permit-categories.xlsx"))
```

```{r, include=FALSE}
# Set working directory
#wd <- getwd()
#setwd(wd)
#setwd("G:/Projects/Monthly-Reports/stl-building-permits")
```

### Actual code for importing data 
```{r, include=FALSE}

#Import data

#channel <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=/data/working-db/bldgpermits/prmdbo
                             #G:/Projects/Monthly-Reports/stl-building-permits/permit-data-cleaning/prmbdo/prmbdo")
```


```{r, include=FALSE}

#Run SQL query to return data

#data <- sqlQuery( channel , paste ("select *
# from PrmBldg"))
```


```{r, include=FALSE}
data%>%
  
  #create year & month variables
  mutate(yr = format(as.Date(data$IssueDate,  format="%d/%m/%Y"), "%Y"))%>%
  mutate(month = format(as.Date(data$IssueDate, format="%d/%m/%Y"), "%m"))%>%
  
  # Use filter command to filter out permits without a cancellation date and with cost of $0
  filter(is.na(CancelDate))%>%
  filter(EstProjectCost != 0)%>% 

  # Filter out 10 neighborhoods we want to study
  filter(Nbrhd %in% c("38", "39", "46", "47", "48", "49", "51", "53", "54", "58"))%>%
  
  
  # Recode values to neighborood names
  mutate(nbhd_name = ifelse(grepl("38", Nbrhd), "Central West End",
                                             ifelse(grepl("39", Nbrhd), "Forest Park Southeast",
                                             ifelse(grepl("46", Nbrhd), "Skinker DeBaliviere",  
                                             ifelse(grepl("47", Nbrhd), "DeBaliviere Place",
                                             ifelse(grepl("48", Nbrhd), "West End",
                                             ifelse(grepl("49", Nbrhd), "Visitation Park",       
                                             ifelse(grepl("51", Nbrhd), "Academy",       
                                             ifelse(grepl("53", Nbrhd), "Fountain Park",       
                                             ifelse(grepl("54", Nbrhd), "Lewis Place",       
                                             ifelse(grepl("58", Nbrhd), "Vandeventer", NA)))))))))))%>%
  
  # Create New Variables for Building Permits Greater/Less Than 50,000
  mutate(big_cost = ifelse(EstProjectCost >= 50000, 1, NA))%>%
  mutate(lil_cost = ifelse(EstProjectCost < 50000, 1, NA))%>%

  #This variable is specifically for individual neighborhood analysis
  mutate(lrgcost = ifelse(grepl("1", big_cost), "> $50,000", "< $50,000"))%>% 
  
  #rename handle
  rename(HANDLE = Handle)%>%
  mutate(abbr = ifelse(grepl("38", Nbrhd), "cwe",
                                             ifelse(grepl("39", Nbrhd), "fpse",
                                             ifelse(grepl("46", Nbrhd), "sdbp",  
                                             ifelse(grepl("47", Nbrhd), "dbp",
                                             ifelse(grepl("48", Nbrhd), "we",
                                             ifelse(grepl("49", Nbrhd), "vp",       
                                             ifelse(grepl("51", Nbrhd), "ac",       
                                             ifelse(grepl("53", Nbrhd), "fp",       
                                             ifelse(grepl("54", Nbrhd), "lp",       
                                             ifelse(grepl("58", Nbrhd), "vd", NA)))))))))))%>%
  
  #Drop unused variables using `select` function, assign to new `df` data frame
  dplyr::select(HANDLE, OwnerName, OrigAddress, OwnerAddr, AppDate, IssueDate,CompleteDate, CancelDate, EstProjectCost, AppDescription, NewUseGroup1, Nbrhd, FirstDate, big_cost, lil_cost, lrgcost, nbhd_name, yr, month, abbr) -> df
#add new_use categories
df <- inner_join(df, cat, by = "NewUseGroup1")
df <- df%>%
  rename(new_use = Field1)%>%
  group_by(nbhd_name, new_use)%>%
  dplyr::select(-Descr)%>%
  mutate(count = n())
```


```{r}
#current month, convert month variable to numeric to compare with params
data_month <- dplyr::filter(df, as.numeric(month) == match(params$month, month.name) & yr == params$year)
#create means data
data_month %>%
  group_by(nbhd_name, new_use) %>%
  summarise(mean = mean(EstProjectCost), count1 = mean(count), high_cost = sum(big_cost, na.rm = TRUE), low_cost = sum(lil_cost, na.rm = TRUE)) -> means

#current year to date
ytd <- filter(df, as.numeric(month) >= 1 & as.numeric(month) <= match(params$month, month.name) & yr == params$year)

#last year this month
lastmonth <- filter(df, as.numeric(month) == match(params$month, month.name) & yr == (params$year-1))

#last year to date
lastytd <- filter(df, as.numeric(month) >= 1 & as.numeric(month) <= match(params$month, month.name) & yr == (params$year-1))

#6 month data
month6 <- filter(df, IssueDate >= as.Date(params$month6) & IssueDate <= as.Date(params$enddate))

save(data_month, means, ytd, lastmonth, lastytd, month6, file = here::here("data", params$year, params$month, "clean-permit-data.rda"))
```

```{r}
# This code cleans our Global Environment and gives you a nice lil' message

rm(list = ls())
print("Congrats! The code ran and you rock! Have a great day champ :)")
```